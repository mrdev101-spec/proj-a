<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Migration V3 (CSV Test)</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBSnjvJdUkka7g1IadUlbPOCeE-KT9O_iA",
            authDomain: "ma-service-40f97.firebaseapp.com",
            projectId: "ma-service-40f97",
            storageBucket: "ma-service-40f97.firebasestorage.app",
            messagingSenderId: "955015176286",
            appId: "1:955015176286:web:cdd9a970e6e4aa6cb914cf",
            measurementId: "G-LD64Q1N0GQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/15TWNJ1vCFzWeFrwBEieRBaY5mf3HcDo_HjX_eyInTfc/export?format=csv';

        async function runTest() {
            const statusDiv = document.getElementById('status');
            const log = (msg) => {
                console.log(msg);
                statusDiv.innerHTML += `<div>${msg}</div>`;
            };

            try {
                log('Starting V3 Test...');

                log('Fetching CSV...');
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                log('CSV fetched. Length: ' + csvText.length);

                const lines = csvText.split(/\r?\n/);
                log('Total lines: ' + lines.length);

                // Find first valid record
                let firstRecord = null;
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const columns = line.split(',');
                    if (columns.length >= 6) {
                        const hcode = columns[2].trim();
                        if (hcode) {
                            firstRecord = {
                                timestamp: columns[0].trim(),
                                name: columns[1].trim(),
                                hcode: hcode,
                                district: columns[3].trim(),
                                pcId: columns[4].trim(),
                                anydesk: columns[5].trim()
                            };
                            log(`Found first valid record at line ${i}: ${JSON.stringify(firstRecord)}`);
                            break;
                        }
                    }
                }

                if (!firstRecord) {
                    throw new Error('No valid records found in CSV');
                }

                log('Attempting to write first record...');
                const docId = String(firstRecord.hcode);
                log(`Using Doc ID: "${docId}" (Type: ${typeof docId})`);

                const ref = doc(db, "hospitals", docId);
                log(`Reference created. Path: ${ref.path}`);

                await setDoc(ref, firstRecord);
                log('Write successful!');

                document.body.style.backgroundColor = 'lightgreen';

            } catch (error) {
                log(`CRITICAL ERROR: ${error.message}`);
                console.error(error);
                document.body.style.backgroundColor = 'lightcoral';
            }
        }

        window.onload = runTest;
    </script>
</head>

<body>
    <h1>Migration V3 (CSV Test)</h1>
    <div id="status"></div>
</body>

</html>